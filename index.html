<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Typing Speed Test Challenge</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --container-bg: white;
            --text-primary: #4a5568;
            --text-secondary: #666;
            --accent-gradient: linear-gradient(45deg, #667eea, #764ba2);
            --border-color: #e2e8f0;
            --input-bg: #f8f9fa;
            --correct-bg: #c6f6d5;
            --correct-text: #22543d;
            --incorrect-bg: #fed7d7;
            --incorrect-text: #742a2a;
            --results-bg: #f0fff4;
            --results-border: #68d391;
            --results-title: #38a169;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(0, 0, 0, 0.15);
            --settings-bg: #f8f9fa;
            --settings-border: #e2e8f0;
            --easy-color: #48bb78;
            --medium-color: #ed8936;
            --hard-color: #e53e3e;
            --keyboard-bg: #f7fafc;
            --keyboard-key: #e2e8f0;
            --keyboard-active: #bee3f8;
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --container-bg: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --accent-gradient: linear-gradient(45deg, #4299e1, #805ad5);
            --border-color: #4a5568;
            --input-bg: #1a202c;
            --correct-bg: #2f855a;
            --correct-text: #c6f6d5;
            --incorrect-bg: #e53e3e;
            --incorrect-text: #fed7d7;
            --results-bg: #1a202c;
            --results-border: #48bb78;
            --results-title: #68d391;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.4);
            --settings-bg: #1a202c;
            --settings-border: #4a5568;
            --keyboard-bg: #2d3748;
            --keyboard-key: #4a5568;
            --keyboard-active: #4299e1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toggle-btn {
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-hover);
        }

        .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .toggle-btn:hover .toggle-icon {
            transform: rotate(20deg);
        }

        .container {
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow);
            padding: 40px;
            max-width: 900px;
            width: 90%;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px var(--shadow-hover);
        }

        h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .description {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .game-area {
            display: none;
            margin-top: 30px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background: var(--input-bg);
            padding: 15px;
            border-radius: 10px;
            position: relative;
        }

        .restart-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            color: #667eea;
            transform: translateY(-50%) rotate(180deg);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .text-display {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.1rem;
            line-height: 1.8;
            text-align: left;
            min-height: 120px;
            color: var(--text-primary);
        }

        .typing-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            line-height: 1.8;
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .typing-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .typing-input:disabled {
            background: #f1f3f4;
            cursor: not-allowed;
        }

        .btn {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .countdown {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            display: none;
        }

        .results {
            display: none;
            background: var(--results-bg);
            border: 2px solid var(--results-border);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
        }

        .results h2 {
            color: var(--results-title);
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .result-item {
            background: var(--container-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .result-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .correct-char {
            background-color: var(--correct-bg);
            color: var(--correct-text);
        }

        .incorrect-char {
            background-color: var(--incorrect-bg);
            color: var(--incorrect-text);
        }

        .high-score {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #744210;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .settings {
            background: var(--settings-bg);
            border: 1px solid var(--settings-border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .settings-label {
            font-weight: bold;
            margin-right: 10px;
            color: var(--text-primary);
        }

        .settings-input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .difficulty-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .difficulty-easy {
            background-color: var(--easy-color);
            color: white;
        }

        .difficulty-medium {
            background-color: var(--medium-color);
            color: white;
        }

        .difficulty-hard {
            background-color: var(--hard-color);
            color: white;
        }

        .keyboard-container {
            margin-top: 20px;
            background: var(--keyboard-bg);
            border-radius: 10px;
            padding: 15px;
            display: none;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
        }

        .keyboard-key {
            background: var(--keyboard-key);
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 0 3px;
            font-family: monospace;
            font-size: 1rem;
            min-width: 30px;
            text-align: center;
            transition: all 0.2s;
        }

        .keyboard-key.active {
            background: var(--keyboard-active);
            transform: scale(1.1);
        }

        .keyboard-key.space {
            width: 200px;
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background: var(--input-bg);
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent-gradient);
            width: 0%;
            transition: width 0.3s ease;
        }

        .achievement-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #744210;
            padding: 5px 10px;
            border-radius: 50px;
            margin: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .theme-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .theme-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .theme-option.selected {
            border-color: var(--text-primary);
        }

        .language-selector {
            margin: 15px 0;
        }

        .home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow);
            z-index: 1000;
        }

        .home-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-hover);
        }

        .home-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .home-btn:hover .home-icon {
            transform: rotate(-20deg);
        }

        /* Responsive design */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .stats {
                flex-direction: column;
                gap: 10px;
            }

            .result-stats {
                grid-template-columns: 1fr;
            }

            .settings-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .settings-input {
                width: 100%;
                margin-top: 5px;
            }

            .restart-btn {
                position: static;
                transform: none;
                margin-top: 10px;
            }

            .keyboard-container {
                display: none !important;
            }

            .home-btn, .dark-mode-toggle {
                width: 40px;
                height: 40px;
            }
        }

        /* Animation for countdown */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .countdown.pulse {
            animation: pulse 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .achievement-badge.unlocked {
            animation: bounce 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Button -->
        <div class="home-btn" id="homeBtn" style="display: none;">
            <span class="home-icon">Hm</span>
        </div>

        <!-- Dark Mode Toggle -->
        <div class="dark-mode-toggle">
            <button id="darkModeBtn" class="toggle-btn" title="Toggle Dark Mode">
                <span class="toggle-icon">D</span>
            </button>
        </div>

        <h1>Advanced Typing Speed Test</h1>
        <p class="description">
            Test and improve your typing skills with customizable challenges. Track your progress and unlock achievements!
        </p>

        <!-- High Score Display -->
        <div id="highScore" class="high-score" style="display: none;">
            Your Best Score: <span id="bestWPM">0</span> WPM
            <span id="bestDifficultyTag" class="difficulty-tag difficulty-medium">Medium</span>
        </div>

        <!-- Start Screen -->
        <div id="startScreen">
            <div class="settings">
                <div class="settings-row">
                    <label for="testMode" class="settings-label">Test Mode:</label>
                    <select id="testMode" class="settings-input">
                        <option value="timed">Timed</option>
                        <option value="words">Word Count</option>
                        <option value="zen">Zen Mode</option>
                        <option value="quote">Quote Mode</option>
                    </select>
                </div>
                
                <div id="timedSettings">
                    <div class="settings-row">
                        <label for="testDuration" class="settings-label">Duration (seconds):</label>
                        <input type="number" id="testDuration" class="settings-input" min="10" max="300" value="60">
                    </div>
                </div>
                
                <div id="wordsSettings" style="display: none;">
                    <div class="settings-row">
                        <label for="wordCount" class="settings-label">Word Count:</label>
                        <select id="wordCount" class="settings-input">
                            <option value="50">50 words</option>
                            <option value="100" selected>100 words</option>
                            <option value="150">150 words</option>
                            <option value="200">200 words</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="settings-row" id="customWordCountRow" style="display: none;">
                        <label for="customWordCount" class="settings-label">Custom Word Count:</label>
                        <input type="number" id="customWordCount" class="settings-input" min="10" max="500" value="100">
                    </div>
                </div>
                
                <div class="settings-row">
                    <label for="difficulty" class="settings-label">Difficulty:</label>
                    <select id="difficulty" class="settings-input">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                
                <div class="settings-row">
                    <label for="language" class="settings-label">Language:</label>
                    <select id="language" class="settings-input">
                        <option value="english">English</option>
                        <option value="spanish">Spanish</option>
                        <option value="french">French</option>
                        <option value="german">German</option>
                    </select>
                </div>
                
                <div class="theme-selector">
                    <div class="theme-option selected" style="background: linear-gradient(135deg, #667eea, #764ba2);" data-theme="default"></div>
                    <div class="theme-option" style="background: linear-gradient(135deg, #4fd1c5, #319795);" data-theme="teal"></div>
                    <div class="theme-option" style="background: linear-gradient(135deg, #f6ad55, #dd6b20);" data-theme="orange"></div>
                    <div class="theme-option" style="background: linear-gradient(135deg, #f687b3, #b83280);" data-theme="pink"></div>
                </div>
                
                <div class="settings-row">
                    <label class="settings-label">Options:</label>
                    <div>
                        <input type="checkbox" id="showKeyboard" checked>
                        <label for="showKeyboard">Show Keyboard</label>
                        <input type="checkbox" id="enableSounds" checked style="margin-left: 10px;">
                        <label for="enableSounds">Enable Sounds</label>
                    </div>
                </div>
            </div>
            
            <div id="achievementsPreview" style="display: none; margin-bottom: 20px;">
                <h3>Your Achievements</h3>
                <div id="achievementsList"></div>
            </div>
            
            <button class="btn" id="startBtn">: ) Start Challenge</button>
            <button class="btn" id="viewStatsBtn" style="background: #4a5568;"> View Statistics</button>
        </div>

        <!-- Countdown -->
        <div id="countdown" class="countdown">3</div>

        <!-- Game Area -->
        <div id="gameArea" class="game-area">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="timer">60</div>
                    <div class="stat-label"><span id="timerLabel">: ( Seconds Left</span></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="wpmLive">0</div>
                    <div class="stat-label">: o WPM</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracyLive">100</div>
                    <div class="stat-label">Accuracy %</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="progressLive">0</div>
                    <div class="stat-label">Progress</div>
                </div>
                <button class="restart-btn" id="restartBtn" title="Restart Test">Res</button>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="text-display" id="textDisplay"></div>
            <textarea 
                class="typing-input" 
                id="typingInput" 
                placeholder="Start typing here when the test begins..."
                disabled
            ></textarea>
            
            <div id="keyboardContainer" class="keyboard-container">
                <!-- Keyboard rows will be generated by JavaScript -->
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="results">
            <h2>Test Complete!</h2>
            <div id="newAchievement" style="display: none; margin-bottom: 20px;">
                <h3>: ) New Achievement Unlocked!</h3>
                <div id="achievementBadge" class="achievement-badge"></div>
            </div>
            
            <div class="result-stats">
                <div class="result-item">
                    <div class="result-value" id="finalWPM">0</div>
                    <div class="stat-label">Words Per Minute</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="finalAccuracy">0</div>
                    <div class="stat-label">Accuracy %</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="totalWords">0</div>
                    <div class="stat-label">Words Typed</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="correctChars">0</div>
                    <div class="stat-label">Correct Characters</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="testDurationResult">0</div>
                    <div class="stat-label">Test Duration</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="difficultyResult">Medium</div>
                    <div class="stat-label">Difficulty</div>
                </div>
            </div>
            
            <div id="errorAnalysis" style="margin: 20px 0; text-align: left; display: none;">
                <h3>Error Analysis</h3>
                <p>Most common errors: <span id="commonErrors"></span></p>
                <p>Most difficult keys: <span id="difficultKeys"></span></p>
            </div>
            
            <button class="btn" id="playAgainBtn">Play Again</button>
            <button class="btn" id="shareResultsBtn" style="background: #4299e1;">Share Results</button>
        </div>
        
        <!-- Statistics Screen -->
        <div id="statsScreen" class="results" style="display: none;">
            <h2>Your Typing Statistics</h2>
            
            <div class="result-stats">
                <div class="result-item">
                    <div class="result-value" id="totalTests">0</div>
                    <div class="stat-label">Tests Completed</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="avgWPM">0</div>
                    <div class="stat-label">Average WPM</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="bestWPMStats">0</div>
                    <div class="stat-label">Best WPM</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="avgAccuracy">0%</div>
                    <div class="stat-label">Average Accuracy</div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <h3>Progress Over Time</h3>
                <canvas id="progressChart" width="400" height="200"></canvas>
            </div>
            
            <div id="allAchievements" style="margin: 20px 0;">
                <h3>Achievements</h3>
                <div id="achievementsStatsList"></div>
            </div>
            
            <button class="btn" id="backToHomeBtn">Back to Home</button>
        </div>
    </div>

    <script>
        // Game state variables
        let gameActive = false;
        let timeLeft = 60;
        let timerInterval;
        let startTime;
        let currentText = "";
        let targetWordCount = 100;
        let testMode = "timed";
        let difficulty = "medium";
        let language = "english";
        let totalCharsTyped = 0;
        let keyPressMap = {};
        let currentKey = null;
        let isDarkMode = false;
        
        // User statistics
        let userStats = {
            testsCompleted: 0,
            totalWordsTyped: 0,
            totalCharsTyped: 0,
            totalCorrectChars: 0,
            bestWPM: 0,
            bestWPMDifficulty: "medium",
            history: [],
            achievements: []
        };
        
        // Sample texts for typing test
        const sampleTexts = {
            english: [
                "The quick brown fox jumps over the lazy dog. This pangram contains every letter of the alphabet at least once. It has been used for typing practice and font testing for many years. The sentence is memorable and easy to type, making it perfect for beginners.",
                "Technology has revolutionized the way we communicate and work. From smartphones to artificial intelligence, innovation continues to shape our daily lives. The internet connects people across the globe instantly, breaking down barriers and creating new opportunities for collaboration and learning.",
                "In a hole in the ground there lived a hobbit. Not a nasty, dirty, wet hole filled with worms and oozy smells, nor yet a dry, bare, sandy hole with nothing to sit down on or to eat. It was a hobbit-hole, and that means comfort and warmth in every corner.",
                "Space exploration represents humanity's greatest adventure. From the first moon landing to Mars rovers, we continue to push the boundaries of what is possible. Each mission teaches us more about our universe and our place within it, inspiring future generations to reach for the stars.",
                "Climate change is one of the most pressing challenges of our time. Rising temperatures, melting ice caps, and extreme weather events are clear indicators that immediate action is required. Through renewable energy, conservation efforts, and international cooperation, we can work together to protect our planet."
            ],
            spanish: [
                "El rápido zorro marrón salta sobre el perro perezoso. Este pangrama contiene todas las letras del alfabeto al menos una vez. Se ha utilizado durante muchos años para practicar mecanografía y probar fuentes. La oración es memorable y fácil de escribir, lo que la hace perfecta para principiantes.",
                "La tecnología ha revolucionado la forma en que nos comunicamos y trabajamos. Desde los teléfonos inteligentes hasta la inteligencia artificial, la innovación continúa dando forma a nuestra vida cotidiana. Internet conecta a las personas de todo el mundo al instante, derribando barreras y creando nuevas oportunidades para la colaboración y el aprendizaje.",
                "En un agujero en el suelo vivía un hobbit. No un agujero desagradable, sucio y húmedo, lleno de gusanos y olores fétidos, ni tampoco un agujero seco, desnudo y arenoso, sin nada en qué sentarse o qué comer. Era un agujero-hobbit, y eso significa comodidad y calor en cada rincón.",
                "La exploración espacial representa la mayor aventura de la humanidad. Desde el primer alunizaje hasta los rovers en Marte, seguimos ampliando los límites de lo posible. Cada misión nos enseña más sobre nuestro universo y nuestro lugar en él, inspirando a las generaciones futuras a alcanzar las estrellas.",
                "El cambio climático es uno de los desafíos más urgentes de nuestro tiempo. El aumento de las temperaturas, el derretimiento de los casquetes polares y los fenómenos meteorológicos extremos son indicadores claros de que se requiere acción inmediata. A través de las energías renovables, los esfuerzos de conservación y la cooperación internacional, podemos trabajar juntos para proteger nuestro planeta."
            ],
            french: [
                "Le rapide renard brun saute par-dessus le chien paresseux. Ce pangramme contient chaque lettre de l'alphabet au moins une fois. Il est utilisé depuis de nombreuses années pour la pratique de la dactylographie et les tests de polices. La phrase est mémorable et facile à taper, ce qui la rend parfaite pour les débutants.",
                "La technologie a révolutionné notre façon de communiquer et de travailler. Des smartphones à l'intelligence artificielle, l'innovation continue de façonner notre vie quotidiana. Internet connecte instantanément les gens à travers le monde, brisant les barrières et créant de nouvelles opportunités de collaboration et d'apprentissage.",
                "Dans un trou vivait un hobbit. Pas un trou méchant, sale et humide, rempli de vers et d'odeurs nauséabondes, ni encore un trou sec, nu et sablonneux, sans rien pour s'asseoir ou pour manger. C'était un trou de hobbit, ce qui signifie confort et chaleur à chaque coin.",
                "L'exploration spatiale représente la plus grande aventure de l'humanité. Du premier alunissage aux rovers martiens, nous continuons à repousser les limites du possible. Chaque mission nous en apprend davantage sur notre univers et notre place en son sein, inspirant les générations futures à viser les étoiles.",
                "Le changement climatique est l'un des défis les plus urgents de notre époque. La hausse des températures, la fonte des calottes glaciaires et les phénomènes météorologiques extrêmes sont des indicateurs clairs qu'une action immédiate est nécessaire. Grâce aux énergies renouvelables, aux efforts de conservation et à la coopération internationale, nous pouvons travailler ensemble pour protéger notre planète."
            ],
            german: [
                "Der schnelle braune Fuchs springt über den faulen Hund. Dieses Pangramm enthält jeden Buchstaben des Alphabets mindestens einmal. Es wird seit vielen Jahren zum Üben des Tippens und zum Testen von Schriftarten verwendet. Der Satz ist einprägsam und leicht zu tippen, was ihn perfekt für Anfänger macht.",
                "Die Technologie hat die Art und Weise, wie wir kommunizieren und arbeiten, revolutioniert. Von Smartphones bis hin zu künstlicher Intelligenz prägt die Innovation weiterhin unser tägliches Leben. Das Internet verbindet Menschen auf der ganzen Welt in Sekundenschnelle, bricht Barrieren ab und schafft neue Möglichkeiten für Zusammenarbeit und Lernen.",
                "In einem Loch im Boden lebte ein Hobbit. Kein ekliges, schmutziges, nasses Loch, voller Würmer und übler Gerüche, auch kein trockenes, kahles, sandiges Loch, ohne etwas zum Sitzen oder Essen. Es war ein Hobbit-Loch, und das bedeutet Behaglichkeit und Wärme in jeder Ecke.",
                "Die Weltraumforschung ist das größte Abenteuer der Menschheit. Von der ersten Mondlandung bis zu den Mars-Rovern erweitern wir ständig die Grenzen des Möglichen. Jede Mission lehrt uns mehr über unser Universum und unseren Platz darin und inspiriert zukünftige Generationen, nach den Sternen zu greifen.",
                "Der Klimawandel ist eine der dringendsten Herausforderungen unserer Zeit. Steigende Temperaturen, schmelzende Eiskappen und extreme Wetterereignisse sind klare Anzeichen dafür, dass sofortiges Handeln erforderlich ist. Durch erneuerbare Energien, Naturschutzbemühungen und internationale Zusammenarbeit können wir gemeinsam unseren Planeten schützen."
            ]
        };
        
        // Famous quotes for quote mode
        const famousQuotes = {
            english: [
                "The only way to do great work is to love what you do. - Steve Jobs",
                "Innovation distinguishes between a leader and a follower. - Steve Jobs",
                "Your time is limited, so don't waste it living someone else's life. - Steve Jobs",
                "Stay hungry, stay foolish. - Steve Jobs",
                "The greatest glory in living lies not in never falling, but in rising every time we fall. - Nelson Mandela",
                "The way to get started is to quit talking and begin doing. - Walt Disney",
                "If life were predictable it would cease to be life, and be without flavor. - Eleanor Roosevelt",
                "If you look at what you have in life, you'll always have more. - Oprah Winfrey",
                "If you set your goals ridiculously high and it's a failure, you will fail above everyone else's success. - James Cameron",
                "Life is what happens when you're busy making other plans. - John Lennon"
            ],
            spanish: [
                "La única manera de hacer un gran trabajo es amar lo que haces. - Steve Jobs",
                "La innovación distingue entre un líder y un seguidor. - Steve Jobs",
                "Tu tiempo es limitado, así que no lo desperdicies viviendo la vida de otro. - Steve Jobs",
                "Sé hambriento, sé insensato. - Steve Jobs",
                "La mayor gloria en la vida no consiste en no caer nunca, sino en levantarnos cada vez que caemos. - Nelson Mandela",
                "La manera de empezar es dejar de hablar y empezar a hacer. - Walt Disney",
                "Si la vida fuera predecible dejaría de ser vida y carecería de sabor. - Eleanor Roosevelt",
                "Si miras lo que tienes en la vida, siempre tendrás más. - Oprah Winfrey",
                "Si estableces metas ridículamente altas y fracasas, fracasarás por encima del éxito de los demás. - James Cameron",
                "La vida es lo que sucede mientras estás ocupado haciendo otros planes. - John Lennon"
            ],
            french: [
                "La seule façon de faire du bon travail est d'aimer ce que vous faites. - Steve Jobs",
                "L'innovation distingue un leader d'un suiveur. - Steve Jobs",
                "Votre temps est limité, alors ne le gaspillez pas à vivre la vie de quelqu'un d'autre. - Steve Jobs",
                "Soyez insatiables. Soyez fous. - Steve Jobs",
                "La plus grande gloire dans la vie ne réside pas dans le fait de ne jamais tomber, mais dans le fait de se relever à chaque chute. - Nelson Mandela",
                "La façon de commencer est d'arrêter de parler et de commencer à faire. - Walt Disney",
                "Si la vie était prévisible, elle cesserait d'être la vie et serait sans saveur. - Eleanor Roosevelt",
                "Si vous regardez ce que vous avez dans la vie, vous aurez toujours plus. - Oprah Winfrey",
                "Si vous fixez des objectifs ridiculement élevés et que c'est un échec, vous échouerez au-dessus du succès de tous les autres. - James Cameron",
                "La vie, c'est ce qui se passe pendant que vous êtes occupé à faire d'autres projets. - John Lennon"
            ],
            german: [
                "Die einzige Möglichkeit, großartige Arbeit zu leisten, ist, zu lieben, was man tut. - Steve Jobs",
                "Innovation unterscheidet einen Leader von einem Folger. - Steve Jobs",
                "Deine Zeit ist begrenzt, also verschwende sie nicht damit, das Leben eines anderen zu leben. - Steve Jobs",
                "Sei hungrig. Sei töricht. - Steve Jobs",
                "Der größte Ruhm im Leben liegt nicht darin, niemals zu fallen, sondern jedes Mal wieder aufzustehen, wenn wir fallen. - Nelson Mandela",
                "Der Weg, um anzufangen, besteht darin, aufzuhören zu reden und anzufangen zu tun. - Walt Disney",
                "Wenn das Leben vorhersehbar wäre, würde es aufhören, Leben zu sein, und wäre ohne Geschmack. - Eleanor Roosevelt",
                "Wenn Sie sich ansehen, was Sie im Leben haben, werden Sie immer mehr haben. - Oprah Winfrey",
                "Wenn Sie sich lächerlich hohe Ziele setzen und es ein Misserfolg ist, werden Sie über den Erfolg aller anderen scheitern. - James Cameron",
                "Das Leben ist das, was passiert, während du damit beschäftigt bist, andere Pläne zu machen. - John Lennon"
            ]
        };
        
        // Achievements
        const achievements = [
            { id: "first_test", name: "First Try", description: "Complete your first typing test", check: (stats) => stats.testsCompleted >= 1 },
            { id: "speed_50", name: "Speedster", description: "Reach 50 WPM in any test", check: (stats) => stats.bestWPM >= 50 },
            { id: "speed_80", name: "Typing Master", description: "Reach 80 WPM in any test", check: (stats) => stats.bestWPM >= 80 },
            { id: "accuracy_95", name: "Precision", description: "Achieve 95% accuracy in any test", check: (stats) => stats.history.some(test => test.accuracy >= 95) },
            { id: "hard_mode", name: "Hardcore Typer", description: "Complete a test on Hard difficulty", check: (stats) => stats.history.some(test => test.difficulty === "hard") },
            { id: "marathon", name: "Marathon", description: "Complete a 5-minute typing test", check: (stats) => stats.history.some(test => test.duration >= 300) },
            { id: "polyglot", name: "Polyglot", description: "Complete tests in 3 different languages", check: (stats) => new Set(stats.history.map(test => test.language)).size >= 3 },
            { id: "perfect", name: "Perfect Score", description: "Achieve 100% accuracy in any test", check: (stats) => stats.history.some(test => test.accuracy === 100) },
            { id: "veteran", name: "Veteran", description: "Complete 10 typing tests", check: (stats) => stats.testsCompleted >= 10 },
            { id: "zen_master", name: "Zen Master", description: "Complete a Zen mode session", check: (stats) => stats.history.some(test => test.mode === "zen") }
        ];
        
        // Keyboard layout
        const keyboardLayout = [
            ["q", "w", "e", "r", "t", "y", "u", "i", "o", "p"],
            ["a", "s", "d", "f", "g", "h", "j", "k", "l"],
            ["z", "x", "c", "v", "b", "n", "m"],
            ["space"]
        ];
        
        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const startScreen = document.getElementById('startScreen');
        const countdown = document.getElementById('countdown');
        const gameArea = document.getElementById('gameArea');
        const textDisplay = document.getElementById('textDisplay');
        const typingInput = document.getElementById('typingInput');
        const timer = document.getElementById('timer');
        const wpmLive = document.getElementById('wpmLive');
        const accuracyLive = document.getElementById('accuracyLive');
        const progressLive = document.getElementById('progressLive');
        const progressBar = document.getElementById('progressBar');
        const results = document.getElementById('results');
        const finalWPM = document.getElementById('finalWPM');
        const finalAccuracy = document.getElementById('finalAccuracy');
        const totalWords = document.getElementById('totalWords');
        const correctChars = document.getElementById('correctChars');
        const testDurationResult = document.getElementById('testDurationResult');
        const difficultyResult = document.getElementById('difficultyResult');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const highScore = document.getElementById('highScore');
        const bestWPM = document.getElementById('bestWPM');
        const bestDifficultyTag = document.getElementById('bestDifficultyTag');
        const darkModeBtn = document.getElementById('darkModeBtn');
        const toggleIcon = document.querySelector('.toggle-icon');
        const restartBtn = document.getElementById('restartBtn');
        const testModeSelect = document.getElementById('testMode');
        const timedSettings = document.getElementById('timedSettings');
        const wordsSettings = document.getElementById('wordsSettings');
        const testDurationInput = document.getElementById('testDuration');
        const wordCountSelect = document.getElementById('wordCount');
        const customWordCountRow = document.getElementById('customWordCountRow');
        const customWordCountInput = document.getElementById('customWordCount');
        const difficultySelect = document.getElementById('difficulty');
        const languageSelect = document.getElementById('language');
        const keyboardContainer = document.getElementById('keyboardContainer');
        const showKeyboardCheckbox = document.getElementById('showKeyboard');
        const enableSoundsCheckbox = document.getElementById('enableSounds');
        const errorAnalysis = document.getElementById('errorAnalysis');
        const commonErrors = document.getElementById('commonErrors');
        const difficultKeys = document.getElementById('difficultKeys');
        const newAchievement = document.getElementById('newAchievement');
        const achievementBadge = document.getElementById('achievementBadge');
        const shareResultsBtn = document.getElementById('shareResultsBtn');
        const viewStatsBtn = document.getElementById('viewStatsBtn');
        const statsScreen = document.getElementById('statsScreen');
        const totalTests = document.getElementById('totalTests');
        const avgWPM = document.getElementById('avgWPM');
        const bestWPMStats = document.getElementById('bestWPMStats');
        const avgAccuracy = document.getElementById('avgAccuracy');
        const achievementsStatsList = document.getElementById('achievementsStatsList');
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        const achievementsPreview = document.getElementById('achievementsPreview');
        const achievementsList = document.getElementById('achievementsList');
        const themeOptions = document.querySelectorAll('.theme-option');
        const timerLabel = document.getElementById('timerLabel');
        const homeBtn = document.getElementById('homeBtn');
        const homeIcon = document.querySelector('.home-icon');

        // Initialize the game
        function init() {
            // Load dark mode preference from localStorage if available
            if (localStorageAvailable()) {
                const savedDarkMode = localStorage.getItem('darkMode');
                if (savedDarkMode === 'true') {
                    isDarkMode = true;
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                
                const savedStats = localStorage.getItem('typingTestStats');
                if (savedStats) {
                    userStats = JSON.parse(savedStats);
                }
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Generate keyboard
            generateKeyboard();
            
            // Show high score if available
            showHighScore();
            
            // Show achievements preview
            showAchievementsPreview();
            
            // Set up theme selector
            setupThemeSelector();
            
            // Update dark mode icon
            updateDarkModeIcon();
        }
        
        // Check if localStorage is available
        function localStorageAvailable() {
            try {
                const test = '__test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            startBtn.addEventListener('click', startGame);
            playAgainBtn.addEventListener('click', resetGame);
            darkModeBtn.addEventListener('click', toggleDarkMode);
            restartBtn.addEventListener('click', restartTest);
            viewStatsBtn.addEventListener('click', showStatsScreen);
            backToHomeBtn.addEventListener('click', hideStatsScreen);
            shareResultsBtn.addEventListener('click', shareResults);
            homeBtn.addEventListener('click', returnToHome);
            
            // Update stats as user types
            typingInput.addEventListener('input', updateStats);
            
            // Prevent pasting
            typingInput.addEventListener('paste', (e) => {
                e.preventDefault();
                showAlert('Pasting is not allowed in the typing test!');
            });
            
            // Handle test mode change
            testModeSelect.addEventListener('change', function() {
                testMode = this.value;
                if (testMode === "timed") {
                    timedSettings.style.display = "block";
                    wordsSettings.style.display = "none";
                    timerLabel.textContent = "Seconds Left";
                } else if (testMode === "words") {
                    timedSettings.style.display = "none";
                    wordsSettings.style.display = "block";
                    timerLabel.textContent = "Words Left";
                } else if (testMode === "zen") {
                    timedSettings.style.display = "none";
                    wordsSettings.style.display = "none";
                    timerLabel.textContent = "Time Elapsed";
                } else if (testMode === "quote") {
                    timedSettings.style.display = "block";
                    wordsSettings.style.display = "none";
                    timerLabel.textContent = "Seconds Left";
                }
            });
            
            // Handle word count change
            wordCountSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customWordCountRow.style.display = 'flex';
                } else {
                    customWordCountRow.style.display = 'none';
                    targetWordCount = parseInt(this.value);
                }
            });
            
            customWordCountInput.addEventListener('input', function() {
                targetWordCount = parseInt(this.value) || 100;
            });
            
            // Keyboard visibility toggle
            showKeyboardCheckbox.addEventListener('change', function() {
                keyboardContainer.style.display = this.checked ? 'block' : 'none';
            });
            
            // Track key presses for heatmap
            document.addEventListener('keydown', (e) => {
                if (!gameActive) return;
                
                // Ignore modifier keys
                if (['Shift', 'Control', 'Alt', 'Meta', 'CapsLock'].includes(e.key)) return;
                
                // Track key press
                keyPressMap[e.key] = (keyPressMap[e.key] || 0) + 1;
                totalCharsTyped++;
                
                // Highlight key on virtual keyboard
                currentKey = e.key.toLowerCase();
                updateKeyboardHighlight();
                
                // Play sound if enabled
                if (enableSoundsCheckbox.checked) {
                    playKeySound();
                }
            });
            
            document.addEventListener('keyup', () => {
                currentKey = null;
                updateKeyboardHighlight();
            });
        }
        
        // Set up theme selector
        function setupThemeSelector() {
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    themeOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Apply theme
                    applyTheme(this.dataset.theme);
                });
            });
        }
        
        // Apply selected theme
        function applyTheme(theme) {
            const root = document.documentElement;
            
            switch(theme) {
                case "teal":
                    root.style.setProperty('--accent-gradient', 'linear-gradient(45deg, #4fd1c5, #319795)');
                    root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #4fd1c5 0%, #319795 100%)');
                    break;
                case "orange":
                    root.style.setProperty('--accent-gradient', 'linear-gradient(45deg, #f6ad55, #dd6b20)');
                    root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #f6ad55 0%, #dd6b20 100%)');
                    break;
                case "pink":
                    root.style.setProperty('--accent-gradient', 'linear-gradient(45deg, #f687b3, #b83280)');
                    root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #f687b3 0%, #b83280 100%)');
                    break;
                default:
                    root.style.setProperty('--accent-gradient', 'linear-gradient(45deg, #667eea, #764ba2)');
                    root.style.setProperty('--bg-gradient', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
            }
        }
        
        // Generate virtual keyboard
        function generateKeyboard() {
            keyboardContainer.innerHTML = '';
            
            keyboardLayout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                
                row.forEach(key => {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'keyboard-key';
                    if (key === "space") {
                        keyDiv.classList.add('space');
                        keyDiv.textContent = 'Space';
                    } else {
                        keyDiv.textContent = key;
                    }
                    keyDiv.dataset.key = key;
                    rowDiv.appendChild(keyDiv);
                });
                
                keyboardContainer.appendChild(rowDiv);
            });
            
            keyboardContainer.style.display = showKeyboardCheckbox.checked ? 'block' : 'none';
        }
        
        // Update keyboard highlight
        function updateKeyboardHighlight() {
            document.querySelectorAll('.keyboard-key').forEach(key => {
                key.classList.remove('active');
                
                if (currentKey) {
                    if (currentKey === " " && key.dataset.key === "space") {
                        key.classList.add('active');
                    } else if (key.dataset.key === currentKey) {
                        key.classList.add('active');
                    }
                }
            });
        }
        
        // Play key sound
        function playKeySound() {
            // In a real implementation, you would play an actual sound file
            // This is a simplified version that just uses the Web Audio API
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.value = currentKey === " " ? 220 : 440 + (Math.random() * 100);
                gainNode.gain.value = 0.1;
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                oscillator.stop(audioCtx.currentTime + 0.1);
            } catch (e) {
                console.log("Audio not supported");
            }
        }
        
        // Show achievements preview
        function showAchievementsPreview() {
            achievementsList.innerHTML = '';
            const unlockedAchievements = achievements.filter(ach => 
                userStats.achievements.includes(ach.id)
            ).slice(0, 3); // Show max 3 achievements
            
            if (unlockedAchievements.length > 0) {
                achievementsPreview.style.display = 'block';
                unlockedAchievements.forEach(ach => {
                    const badge = document.createElement('div');
                    badge.className = 'achievement-badge';
                    badge.textContent = ach.name;
                    badge.title = ach.description;
                    achievementsList.appendChild(badge);
                });
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            updateDarkModeIcon();
            
            if (localStorageAvailable()) {
                localStorage.setItem('darkMode', isDarkMode);
            }
        }
        
        // Update dark mode icon
        function updateDarkModeIcon() {
            toggleIcon.textContent = isDarkMode ? '??' : '??';
        }
        
        // Show high score if it exists
        function showHighScore() {
            if (userStats.bestWPM > 0) {
                bestWPM.textContent = userStats.bestWPM;
                bestDifficultyTag.textContent = userStats.bestWPMDifficulty.charAt(0).toUpperCase() + userStats.bestWPMDifficulty.slice(1);
                bestDifficultyTag.className = `difficulty-tag difficulty-${userStats.bestWPMDifficulty}`;
                highScore.style.display = 'block';
            }
        }
        
        // Start the game
        function startGame() {
            // Get settings
            testMode = testModeSelect.value;
            timeLeft = parseInt(testDurationInput.value) || 60;
            difficulty = difficultySelect.value;
            language = languageSelect.value;
            
            if (wordCountSelect.value === 'custom') {
                targetWordCount = parseInt(customWordCountInput.value) || 100;
            } else {
                targetWordCount = parseInt(wordCountSelect.value) || 100;
            }
            
            startScreen.style.display = 'none';
            homeBtn.style.display = 'flex';
            startCountdown();
        }
        
        // Countdown before game starts
        function startCountdown() {
            let count = 3;
            countdown.style.display = 'block';
            countdown.classList.add('pulse');
            
            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdown.textContent = count;
                } else if (count === 0) {
                    countdown.textContent = 'GO!';
                } else {
                    clearInterval(countInterval);
                    countdown.style.display = 'none';
                    countdown.classList.remove('pulse');
                    beginTest();
                }
            }, 1000);
        }
        
        // Generate text based on difficulty
        function generateText(wordCount, difficulty, language, mode) {
            if (mode === "quote") {
                const quotes = famousQuotes[language] || famousQuotes.english;
                return quotes[Math.floor(Math.random() * quotes.length)];
            }
            
            const baseTexts = sampleTexts[language] || sampleTexts.english;
            const baseText = baseTexts[Math.floor(Math.random() * baseTexts.length)];
            const words = baseText.split(/\s+/);
            
            // Filter words based on difficulty
            const difficultyFilters = {
                easy: word => word.length <= 5 && !/[.,!?;:]/.test(word),
                medium: word => word.length <= 8,
                hard: word => true
            };
            
            const filteredWords = words.filter(difficultyFilters[difficulty]);
            
            // Build text with required word count
            let result = [];
            while (result.length < wordCount) {
                const randomWord = filteredWords[Math.floor(Math.random() * filteredWords.length)] || "the";
                result.push(randomWord);
            }
            
            return result.slice(0, wordCount).join(' ');
        }
        
        // Begin the actual typing test
        function beginTest() {
            gameActive = true;
            gameArea.style.display = 'block';
            keyPressMap = {};
            totalCharsTyped = 0;
            
            // Generate text based on settings
            if (testMode === "quote") {
                currentText = famousQuotes[language][Math.floor(Math.random() * famousQuotes[language].length)];
            } else {
                currentText = generateText(targetWordCount, difficulty, language, testMode);
            }
            
            textDisplay.textContent = currentText;
            
            // Enable input and focus
            typingInput.disabled = false;
            typingInput.value = '';
            typingInput.focus();
            
            // Start timer
            startTime = Date.now();
            
            if (testMode === "timed" || testMode === "quote") {
                timeLeft = parseInt(testDurationInput.value) || 60;
                timer.textContent = timeLeft;
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timer.textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        endTest();
                    }
                }, 1000);
            } else if (testMode === "words") {
                timeLeft = targetWordCount;
                timer.textContent = timeLeft;
                
                timerInterval = setInterval(() => {
                    const wordsTyped = typingInput.value.trim().split(/\s+/).length;
                    const wordsLeft = Math.max(0, targetWordCount - wordsTyped);
                    timer.textContent = wordsLeft;
                    
                    if (wordsLeft <= 0) {
                        endTest();
                    }
                }, 100);
            } else if (testMode === "zen") {
                timeLeft = 0;
                timerInterval = setInterval(() => {
                    timeLeft++;
                    timer.textContent = timeLeft;
                }, 1000);
            }
        }
        
        // Update live statistics
        function updateStats() {
            if (!gameActive) return;
            
            const typedText = typingInput.value;
            
            // Calculate accuracy
            let correctCharsCount = 0;
            for (let i = 0; i < typedText.length; i++) {
                if (i < currentText.length && typedText[i] === currentText[i]) {
                    correctCharsCount++;
                }
            }
            
            const accuracy = typedText.length > 0 ? Math.round((correctCharsCount / typedText.length) * 100) : 100;
            accuracyLive.textContent = accuracy;
            
            // Calculate WPM
            const timeElapsed = (Date.now() - startTime) / 1000 / 60; // in minutes
            const wordsTyped = typedText.trim().split(/\s+/).length;
            const wpm = timeElapsed > 0 ? Math.round(wordsTyped / timeElapsed) : 0;
            wpmLive.textContent = wpm;
            
            // Calculate progress
            let progress = 0;
            if (testMode === "timed" || testMode === "quote") {
                const duration = parseInt(testDurationInput.value) || 60;
                progress = Math.min(100, Math.round((duration - timeLeft) / duration * 100));
            } else if (testMode === "words") {
                progress = Math.min(100, Math.round(typedText.length / currentText.length * 100));
            } else if (testMode === "zen") {
                progress = Math.round(typedText.length / 100); // Just show character count / 100
            }
            
            progressLive.textContent = `${progress}%`;
            progressBar.style.width = `${progress}%`;
            
            // Highlight text
            highlightText(typedText, currentText);
            
            // End test if in words mode and all words are typed
            if (testMode === "words" && typedText.trim().split(/\s+/).length >= targetWordCount) {
                endTest();
            }
        }
        
        // Highlight correct and incorrect characters
        function highlightText(typed, original) {
            let highlightedText = '';
            
            for (let i = 0; i < original.length; i++) {
                if (i < typed.length) {
                    if (typed[i] === original[i]) {
                        highlightedText += `<span class="correct-char">${original[i]}</span>`;
                    } else {
                        highlightedText += `<span class="incorrect-char">${original[i]}</span>`;
                    }
                } else {
                    highlightedText += original[i];
                }
            }
            
            textDisplay.innerHTML = highlightedText;
        }
        
        // End the test and show results
        function endTest() {
            gameActive = false;
            clearInterval(timerInterval);
            typingInput.disabled = true;
            
            const typedText = typingInput.value;
            const originalDuration = testMode === "timed" || testMode === "quote" ? 
                (parseInt(testDurationInput.value) || 60) : 
                (testMode === "words" ? 0 : timeLeft);
                
            const actualDuration = testMode === "timed" || testMode === "quote" ? 
                (originalDuration - timeLeft) : 
                (testMode === "words" ? Math.round((Date.now() - startTime) / 1000) : timeLeft);
            
            // Calculate final statistics
            let correctCharsCount = 0;
            for (let i = 0; i < typedText.length; i++) {
                if (i < currentText.length && typedText[i] === currentText[i]) {
                    correctCharsCount++;
                }
            }
            
            const accuracy = typedText.length > 0 ? Math.round((correctCharsCount / typedText.length) * 100) : 0;
            const wordsTyped = typedText.trim().split(/\s+/).filter(word => word.length > 0).length;
            const wpm = actualDuration > 0 ? Math.round((wordsTyped / actualDuration) * 60) : 0;
            
            // Update results display
            finalWPM.textContent = wpm;
            finalAccuracy.textContent = accuracy;
            totalWords.textContent = wordsTyped;
            correctChars.textContent = correctCharsCount;
            testDurationResult.textContent = `${actualDuration}s`;
            
            const difficultyDisplay = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
            difficultyResult.textContent = difficultyDisplay;
            difficultyResult.className = `difficulty-tag difficulty-${difficulty}`;
            
            // Show error analysis if there were errors
            if (typedText.length > 0 && accuracy < 100) {
                errorAnalysis.style.display = 'block';
                
                // Find most common errors (simplified)
                const errorMap = {};
                for (let i = 0; i < Math.min(typedText.length, currentText.length); i++) {
                    if (typedText[i] !== currentText[i]) {
                        const errorKey = `${typedText[i]}?${currentText[i]}`;
                        errorMap[errorKey] = (errorMap[errorKey] || 0) + 1;
                    }
                }
                
                const commonErrorList = Object.entries(errorMap)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([error]) => error)
                    .join(', ');
                
                commonErrors.textContent = commonErrorList || "None";
                
                // Find most difficult keys (simplified)
                const keyAccuracy = {};
                Object.keys(keyPressMap).forEach(key => {
                    const correctPresses = Array.from(typedText).filter((char, i) => 
                        char === key && i < currentText.length && char === currentText[i]
                    ).length;
                    const accuracy = keyPressMap[key] > 0 ? 
                        Math.round((correctPresses / keyPressMap[key]) * 100) : 0;
                    keyAccuracy[key] = accuracy;
                });
                
                const difficultKeyList = Object.entries(keyAccuracy)
                    .sort((a, b) => a[1] - b[1])
                    .slice(0, 3)
                    .map(([key]) => key === " " ? "Space" : key)
                    .join(', ');
                
                difficultKeys.textContent = difficultKeyList || "None";
            } else {
                errorAnalysis.style.display = 'none';
            }
            
            // Update user statistics
            updateUserStats({
                wpm,
                accuracy,
                wordsTyped,
                correctChars: correctCharsCount,
                duration: actualDuration,
                difficulty,
                language,
                mode: testMode
            });
            
            // Check for new achievements
            checkAchievements();
            
            // Show results
            gameArea.style.display = 'none';
            results.style.display = 'block';
            
            // Play completion sound if enabled
            if (enableSoundsCheckbox.checked) {
                playCompletionSound();
            }
        }
        
        // Update user statistics
        function updateUserStats(testResults) {
            userStats.testsCompleted++;
            userStats.totalWordsTyped += testResults.wordsTyped;
            userStats.totalCharsTyped += totalCharsTyped;
            userStats.totalCorrectChars += testResults.correctChars;
            
            if (testResults.wpm > userStats.bestWPM) {
                userStats.bestWPM = testResults.wpm;
                userStats.bestWPMDifficulty = testResults.difficulty;
            }
            
            // Add to history
            userStats.history.push({
                date: new Date().toISOString(),
                wpm: testResults.wpm,
                accuracy: testResults.accuracy,
                duration: testResults.duration,
                difficulty: testResults.difficulty,
                language: testResults.language,
                mode: testResults.mode
            });
            
            // Keep only last 50 tests in history
            if (userStats.history.length > 50) {
                userStats.history.shift();
            }
            
            // Save to localStorage if available
            if (localStorageAvailable()) {
                localStorage.setItem('typingTestStats', JSON.stringify(userStats));
            }
            
            // Update high score display
            showHighScore();
        }
        
        // Check for new achievements
        function checkAchievements() {
            const unlockedAchievements = achievements.filter(ach => 
                ach.check(userStats) && !userStats.achievements.includes(ach.id)
            );
            
            if (unlockedAchievements.length > 0) {
                // Add new achievements to user stats
                unlockedAchievements.forEach(ach => {
                    userStats.achievements.push(ach.id);
                });
                
                // Save updated stats
                if (localStorageAvailable()) {
                    localStorage.setItem('typingTestStats', JSON.stringify(userStats));
                }
                
                // Show the first new achievement
                const newAch = unlockedAchievements[0];
                achievementBadge.textContent = newAch.name;
                achievementBadge.title = newAch.description;
                newAchievement.style.display = 'block';
                
                // Animate the badge
                setTimeout(() => {
                    achievementBadge.classList.add('unlocked');
                    setTimeout(() => {
                        achievementBadge.classList.remove('unlocked');
                    }, 1000);
                }, 100);
            } else {
                newAchievement.style.display = 'none';
            }
        }
        
        // Play completion sound
        function playCompletionSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.5);
                
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch (e) {
                console.log("Audio not supported");
            }
        }
        
        // Reset game for play again
        function resetGame() {
            gameActive = false;
            
            if (testMode === "timed" || testMode === "quote") {
                timeLeft = parseInt(testDurationInput.value) || 60;
            } else if (testMode === "words") {
                timeLeft = targetWordCount;
            } else {
                timeLeft = 0;
            }
            
            typingInput.value = '';
            typingInput.disabled = true;
            
            // Hide all screens
            results.style.display = 'none';
            gameArea.style.display = 'none';
            countdown.style.display = 'none';
            homeBtn.style.display = 'none';
            
            // Show start screen
            startScreen.style.display = 'block';
            
            // Reset live stats
            timer.textContent = timeLeft;
            wpmLive.textContent = '0';
            accuracyLive.textContent = '100';
            progressLive.textContent = '0%';
            progressBar.style.width = '0%';
            
            // Update achievements preview
            showAchievementsPreview();
        }
        
        // Restart the current test
        function restartTest() {
            if (!gameActive) return;
            
            clearInterval(timerInterval);
            typingInput.value = '';
            
            if (testMode === "timed" || testMode === "quote") {
                timeLeft = parseInt(testDurationInput.value) || 60;
            } else if (testMode === "words") {
                timeLeft = targetWordCount;
            } else {
                timeLeft = 0;
            }
            
            timer.textContent = timeLeft;
            wpmLive.textContent = '0';
            accuracyLive.textContent = '100';
            progressLive.textContent = '0%';
            progressBar.style.width = '0%';
            
            // Start new test immediately
            startTime = Date.now();
            
            if (testMode === "timed" || testMode === "quote") {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timer.textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        endTest();
                    }
                }, 1000);
            } else if (testMode === "words") {
                timerInterval = setInterval(() => {
                    const wordsTyped = typingInput.value.trim().split(/\s+/).length;
                    const wordsLeft = Math.max(0, targetWordCount - wordsTyped);
                    timer.textContent = wordsLeft;
                    
                    if (wordsLeft <= 0) {
                        endTest();
                    }
                }, 100);
            } else if (testMode === "zen") {
                timeLeft = 0;
                timerInterval = setInterval(() => {
                    timeLeft++;
                    timer.textContent = timeLeft;
                }, 1000);
            }
            
            typingInput.focus();
        }
        
        // Show statistics screen
        function showStatsScreen() {
            startScreen.style.display = 'none';
            homeBtn.style.display = 'none';
            statsScreen.style.display = 'block';
            
            // Update stats
            totalTests.textContent = userStats.testsCompleted;
            avgWPM.textContent = userStats.testsCompleted > 0 ? 
                Math.round(userStats.history.reduce((sum, test) => sum + test.wpm, 0) / userStats.history.length) : 0;
            bestWPMStats.textContent = userStats.bestWPM;
            
            const avgAcc = userStats.testsCompleted > 0 ? 
                Math.round(userStats.history.reduce((sum, test) => sum + test.accuracy, 0) / userStats.history.length) : 0;
            avgAccuracy.textContent = `${avgAcc}%`;
            
            // Show achievements
            achievementsStatsList.innerHTML = '';
            achievements.forEach(ach => {
                const hasAchievement = userStats.achievements.includes(ach.id);
                const achDiv = document.createElement('div');
                achDiv.className = 'achievement-badge';
                if (!hasAchievement) {
                    achDiv.style.opacity = '0.5';
                    achDiv.style.background = '#ccc';
                    achDiv.style.color = '#666';
                }
                achDiv.textContent = ach.name;
                achDiv.title = `${ach.description}${hasAchievement ? '' : ' (Locked)'}`;
                achievementsStatsList.appendChild(achDiv);
            });
            
            // Draw progress chart (simplified - in a real app you would use Chart.js or similar)
            drawProgressChart();
        }
        
        // Draw progress chart
        function drawProgressChart() {
            const canvas = document.getElementById('progressChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (userStats.history.length < 2) {
                ctx.font = '16px Arial';
                ctx.fillStyle = 'var(--text-primary)';
                ctx.textAlign = 'center';
                ctx.fillText('Not enough data to show progress', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Draw axes
            ctx.strokeStyle = 'var(--text-primary)';
            ctx.lineWidth = 1;
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(30, canvas.height - 30);
            ctx.lineTo(canvas.width - 30, canvas.height - 30);
            ctx.stroke();
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(30, 30);
            ctx.lineTo(30, canvas.height - 30);
            ctx.stroke();
            
            // Find max WPM for scaling
            const maxWPM = Math.max(...userStats.history.map(test => test.wpm), 100);
            const minWPM = Math.min(...userStats.history.map(test => test.wpm), 0);
            
            // Draw grid lines and labels
            ctx.font = '10px Arial';
            ctx.fillStyle = 'var(--text-primary)';
            ctx.textAlign = 'right';
            
            // Y-axis labels
            const ySteps = 5;
            for (let i = 0; i <= ySteps; i++) {
                const y = 30 + (canvas.height - 60) * (1 - i / ySteps);
                const wpm = minWPM + (maxWPM - minWPM) * (i / ySteps);
                
                ctx.beginPath();
                ctx.moveTo(25, y);
                ctx.lineTo(30, y);
                ctx.stroke();
                
                ctx.fillText(Math.round(wpm).toString(), 25, y + 4);
            }
            
            // X-axis labels (dates)
            ctx.textAlign = 'center';
            const xSteps = Math.min(5, userStats.history.length);
            for (let i = 0; i < xSteps; i++) {
                const idx = Math.floor(userStats.history.length * (i / (xSteps - 1)));
                const x = 30 + (canvas.width - 60) * (i / (xSteps - 1));
                const date = new Date(userStats.history[idx].date);
                const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
                
                ctx.beginPath();
                ctx.moveTo(x, canvas.height - 30);
                ctx.lineTo(x, canvas.height - 25);
                ctx.stroke();
                
                ctx.fillText(dateStr, x, canvas.height - 15);
            }
            
            // Draw WPM line
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            userStats.history.forEach((test, idx) => {
                const x = 30 + (canvas.width - 60) * (idx / (userStats.history.length - 1));
                const y = 30 + (canvas.height - 60) * (1 - (test.wpm - minWPM) / (maxWPM - minWPM));
                
                if (idx === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw accuracy line
            ctx.strokeStyle = '#48bb78';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            userStats.history.forEach((test, idx) => {
                const x = 30 + (canvas.width - 60) * (idx / (userStats.history.length - 1));
                const y = 30 + (canvas.height - 60) * (1 - test.accuracy / 100);
                
                if (idx === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Add legend
            ctx.font = '12px Arial';
            ctx.fillStyle = '#667eea';
            ctx.fillText('WPM', canvas.width - 50, 20);
            ctx.fillStyle = '#48bb78';
            ctx.fillText('Accuracy %', canvas.width - 50, 35);
        }
        
        // Hide statistics screen
        function hideStatsScreen() {
            statsScreen.style.display = 'none';
            startScreen.style.display = 'block';
        }
        
        // Return to home screen
        function returnToHome() {
            if (gameActive) {
                if (confirm('Are you sure you want to quit the current test?')) {
                    clearInterval(timerInterval);
                    gameActive = false;
                    gameArea.style.display = 'none';
                    results.style.display = 'none';
                    countdown.style.display = 'none';
                    startScreen.style.display = 'block';
                    homeBtn.style.display = 'none';
                }
            } else {
                results.style.display = 'none';
                startScreen.style.display = 'block';
                homeBtn.style.display = 'none';
            }
        }
        
        // Share results
        function shareResults() {
            const resultText = `I scored ${finalWPM.textContent} WPM with ${finalAccuracy.textContent}% accuracy on the typing test!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Typing Test Results',
                    text: resultText,
                    url: window.location.href
                }).catch(err => {
                    showAlert('Sharing was cancelled');
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                prompt('Copy your results to share:', resultText);
            }
        }
        
        // Show alert message
        function showAlert(message) {
            alert(message);
        }
        
        // Initialize the game
        init();
    </script>
</body>
</html>